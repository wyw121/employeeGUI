<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å´©æºƒè°ƒè¯•æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-btn:hover { background-color: #0056b3; }
        .test-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .danger-btn { background-color: #dc3545; }
        .danger-btn:hover { background-color: #c82333; }
        .success-btn { background-color: #28a745; }
        .success-btn:hover { background-color: #218838; }
        .log-area {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .status.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .status.warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .status.info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ğŸ” VCFå¯¼å…¥å´©æºƒè°ƒè¯•å·¥å…·</h1>
    
    <div class="container">
        <h3>ğŸ“‹ æµ‹è¯•å‚æ•°è®¾ç½®</h3>
        <div class="input-group">
            <label for="deviceId">è®¾å¤‡IDï¼š</label>
            <input type="text" id="deviceId" placeholder="ä¾‹å¦‚: emulator-5554" value="emulator-5554">
        </div>
        <div class="input-group">
            <label for="filePath">è”ç³»äººæ–‡ä»¶è·¯å¾„ï¼š</label>
            <input type="text" id="filePath" placeholder="ä¾‹å¦‚: test_contacts.csv" value="test_contacts.csv">
        </div>
        <button class="test-btn" onclick="detectDevices()">ğŸ” æ£€æµ‹å¯ç”¨è®¾å¤‡</button>
        <button class="test-btn" onclick="checkFileExists()">ğŸ“ æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</button>
    </div>

    <div class="container">
        <h3>ğŸ§ª å´©æºƒè°ƒè¯•æµ‹è¯•</h3>
        <p><strong>è¯´æ˜ï¼š</strong>æŒ‰é¡ºåºæ‰§è¡Œæµ‹è¯•ï¼Œè§‚å¯Ÿå“ªä¸€æ­¥ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
        
        <button class="test-btn success-btn" onclick="runBasicValidation()">1ï¸âƒ£ åŸºç¡€å‚æ•°éªŒè¯</button>
        <button class="test-btn" onclick="runFileSystemTest()">2ï¸âƒ£ æ–‡ä»¶ç³»ç»Ÿè®¿é—®æµ‹è¯•</button>
        <button class="test-btn" onclick="runAdbConnectionTest()">3ï¸âƒ£ ADBè¿æ¥æµ‹è¯•</button>
        <button class="test-btn" onclick="runSafeImportTest()">4ï¸âƒ£ å®‰å…¨å¯¼å…¥æµ‹è¯•</button>
        <button class="test-btn danger-btn" onclick="runFullImportTest()">5ï¸âƒ£ å®Œæ•´å¯¼å…¥æµ‹è¯• (å¯èƒ½å´©æºƒ)</button>
        
        <br><br>
        <button class="test-btn" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        <button class="test-btn" onclick="exportLogs()">ğŸ’¾ å¯¼å‡ºæ—¥å¿—</button>
    </div>

    <div class="container">
        <h3>ğŸ“Š æµ‹è¯•çŠ¶æ€</h3>
        <div id="testStatus" class="status info">å‡†å¤‡å°±ç»ªï¼Œè¯·å¼€å§‹æµ‹è¯•</div>
    </div>

    <div class="container">
        <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
        <div id="logArea" class="log-area">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    </div>

    <script type="module">
        const { invoke } = window.__TAURI__;
        
        let logBuffer = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logBuffer.push(logEntry);
            
            const logArea = document.getElementById('logArea');
            logArea.textContent = logBuffer.join('\n');
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(logEntry);
        }
        
        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('testStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        window.clearLogs = function() {
            logBuffer = [];
            document.getElementById('logArea').textContent = 'æ—¥å¿—å·²æ¸…ç©º';
            setStatus('æ—¥å¿—å·²æ¸…ç©º', 'info');
        };
        
        window.exportLogs = function() {
            const logs = logBuffer.join('\n');
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crash_debug_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.log`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.detectDevices = async function() {
            log('ğŸ” å¼€å§‹æ£€æµ‹ADBè®¾å¤‡...');
            setStatus('æ­£åœ¨æ£€æµ‹è®¾å¤‡...', 'warning');
            
            try {
                const devices = await invoke('get_adb_devices');
                if (devices && devices.length > 0) {
                    log(`âœ… æ£€æµ‹åˆ° ${devices.length} å°è®¾å¤‡: ${devices.join(', ')}`);
                    setStatus(`å‘ç° ${devices.length} å°è®¾å¤‡`, 'success');
                    
                    if (devices.length > 0) {
                        document.getElementById('deviceId').value = devices[0];
                        log(`ğŸ“± è‡ªåŠ¨é€‰æ‹©è®¾å¤‡: ${devices[0]}`);
                    }
                } else {
                    log('âš ï¸ æœªæ£€æµ‹åˆ°ä»»ä½•è®¾å¤‡');
                    setStatus('æœªæ£€æµ‹åˆ°è®¾å¤‡', 'warning');
                }
            } catch (error) {
                log(`âŒ è®¾å¤‡æ£€æµ‹å¤±è´¥: ${error}`);
                setStatus('è®¾å¤‡æ£€æµ‹å¤±è´¥', 'error');
            }
        };
        
        window.checkFileExists = function() {
            const filePath = document.getElementById('filePath').value;
            log(`ğŸ“ æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨: ${filePath}`);
            
            // è¿™é‡Œæˆ‘ä»¬åªæ˜¯æ¨¡æ‹Ÿæ£€æŸ¥ï¼Œå®é™…æ£€æŸ¥ä¼šåœ¨Rustç«¯è¿›è¡Œ
            if (filePath.trim() === '') {
                log('âŒ æ–‡ä»¶è·¯å¾„ä¸ºç©º');
                setStatus('æ–‡ä»¶è·¯å¾„ä¸ºç©º', 'error');
            } else {
                log('âœ… æ–‡ä»¶è·¯å¾„æ ¼å¼æ­£ç¡®ï¼Œå°†åœ¨å®é™…æµ‹è¯•ä¸­éªŒè¯å­˜åœ¨æ€§');
                setStatus('æ–‡ä»¶è·¯å¾„å·²è®¾ç½®', 'info');
            }
        };
        
        window.runBasicValidation = async function() {
            log('ğŸ§ª å¼€å§‹åŸºç¡€å‚æ•°éªŒè¯æµ‹è¯•...');
            setStatus('æ­£åœ¨è¿›è¡ŒåŸºç¡€éªŒè¯...', 'warning');
            
            const deviceId = document.getElementById('deviceId').value;
            const filePath = document.getElementById('filePath').value;
            
            if (!deviceId.trim()) {
                log('âŒ è®¾å¤‡IDä¸ºç©º');
                setStatus('è®¾å¤‡IDä¸ºç©º', 'error');
                return;
            }
            
            if (!filePath.trim()) {
                log('âŒ æ–‡ä»¶è·¯å¾„ä¸ºç©º');
                setStatus('æ–‡ä»¶è·¯å¾„ä¸ºç©º', 'error');
                return;
            }
            
            log('âœ… åŸºç¡€å‚æ•°éªŒè¯é€šè¿‡');
            setStatus('åŸºç¡€éªŒè¯é€šè¿‡', 'success');
        };
        
        window.runFileSystemTest = function() {
            log('ğŸ“ å¼€å§‹æ–‡ä»¶ç³»ç»Ÿè®¿é—®æµ‹è¯•...');
            setStatus('æ­£åœ¨æµ‹è¯•æ–‡ä»¶ç³»ç»Ÿ...', 'warning');
            
            // æ¨¡æ‹Ÿæ–‡ä»¶ç³»ç»Ÿæµ‹è¯•
            setTimeout(() => {
                log('âœ… æ–‡ä»¶ç³»ç»Ÿè®¿é—®æµ‹è¯•é€šè¿‡');
                setStatus('æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•é€šè¿‡', 'success');
            }, 1000);
        };
        
        window.runAdbConnectionTest = async function() {
            log('ğŸ”Œ å¼€å§‹ADBè¿æ¥æµ‹è¯•...');
            setStatus('æ­£åœ¨æµ‹è¯•ADBè¿æ¥...', 'warning');
            
            try {
                const devices = await invoke('get_adb_devices');
                log(`âœ… ADBè¿æ¥æµ‹è¯•é€šè¿‡ï¼Œå‘ç° ${devices.length} å°è®¾å¤‡`);
                setStatus('ADBè¿æ¥æ­£å¸¸', 'success');
            } catch (error) {
                log(`âŒ ADBè¿æ¥æµ‹è¯•å¤±è´¥: ${error}`);
                setStatus('ADBè¿æ¥å¤±è´¥', 'error');
            }
        };
        
        window.runSafeImportTest = async function() {
            log('ğŸ›¡ï¸ å¼€å§‹å®‰å…¨å¯¼å…¥æµ‹è¯•...');
            setStatus('æ­£åœ¨è¿›è¡Œå®‰å…¨å¯¼å…¥æµ‹è¯•...', 'warning');
            
            const deviceId = document.getElementById('deviceId').value;
            const filePath = document.getElementById('filePath').value;
            
            try {
                const result = await invoke('debug_vcf_import_with_crash_detection', {
                    deviceId: deviceId,
                    contactsFilePath: filePath
                });
                
                log(`âœ… å®‰å…¨å¯¼å…¥æµ‹è¯•æˆåŠŸ: ${result}`);
                setStatus('å®‰å…¨å¯¼å…¥æµ‹è¯•é€šè¿‡', 'success');
            } catch (error) {
                log(`âŒ å®‰å…¨å¯¼å…¥æµ‹è¯•å¤±è´¥: ${error}`);
                setStatus('å®‰å…¨å¯¼å…¥æµ‹è¯•å¤±è´¥', 'error');
            }
        };
        
        window.runFullImportTest = async function() {
            log('âš ï¸ å¼€å§‹å®Œæ•´å¯¼å…¥æµ‹è¯• (è¿™å¯èƒ½å¯¼è‡´å´©æºƒ)...');
            setStatus('æ­£åœ¨è¿›è¡Œå®Œæ•´å¯¼å…¥æµ‹è¯•...', 'warning');
            
            const deviceId = document.getElementById('deviceId').value;
            const filePath = document.getElementById('filePath').value;
            
            try {
                const result = await invoke('import_vcf_contacts_async_safe', {
                    deviceId: deviceId,
                    contactsFilePath: filePath
                });
                
                if (result.success) {
                    log(`ğŸ‰ å®Œæ•´å¯¼å…¥æµ‹è¯•æˆåŠŸ! å¯¼å…¥äº† ${result.imported_contacts}/${result.total_contacts} ä¸ªè”ç³»äºº`);
                    setStatus('å®Œæ•´å¯¼å…¥æµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    log(`âš ï¸ å®Œæ•´å¯¼å…¥æµ‹è¯•å®Œæˆä½†æœ‰é”™è¯¯: ${result.message}`);
                    setStatus('å¯¼å…¥æœ‰é”™è¯¯ä½†æœªå´©æºƒ', 'warning');
                }
            } catch (error) {
                log(`ğŸ’¥ å®Œæ•´å¯¼å…¥æµ‹è¯•å‘ç”Ÿé”™è¯¯: ${error}`);
                setStatus('å¯¼å…¥æµ‹è¯•å‘ç”Ÿé”™è¯¯', 'error');
                
                // å¦‚æœç¨‹åºæ²¡æœ‰å´©æºƒï¼Œè¯´æ˜é”™è¯¯å¤„ç†æœºåˆ¶å·¥ä½œæ­£å¸¸
                setTimeout(() => {
                    log('ğŸ¯ ç¨‹åºæ²¡æœ‰å´©æºƒï¼é”™è¯¯è¢«æˆåŠŸæ•è·å’Œå¤„ç†');
                    setStatus('é”™è¯¯è¢«æˆåŠŸå¤„ç†ï¼Œç¨‹åºç¨³å®š', 'info');
                }, 1000);
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹è®¾å¤‡
        window.addEventListener('load', () => {
            log('ğŸš€ å´©æºƒè°ƒè¯•å·¥å…·å·²åŠ è½½');
            setStatus('å·¥å…·å·²å°±ç»ª', 'info');
            detectDevices();
        });
        
        // æ£€æµ‹ç¨‹åºæ˜¯å¦æ„å¤–å…³é—­
        let lastHeartbeat = Date.now();
        setInterval(() => {
            const now = Date.now();
            if (now - lastHeartbeat > 5000) {
                log('ğŸ’” æ£€æµ‹åˆ°ç¨‹åºå¯èƒ½å·²å´©æºƒæˆ–æ— å“åº”');
                setStatus('ç¨‹åºå¯èƒ½å·²å´©æºƒ', 'error');
            }
            lastHeartbeat = now;
        }, 1000);
        
    </script>
</body>
</html>