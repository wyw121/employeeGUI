<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCFå¯¼å…¥å´©æºƒä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>VCFå¯¼å…¥å´©æºƒä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section info">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•VCFå¯¼å…¥åŠŸèƒ½çš„å´©æºƒä¿®å¤ã€‚è¯·ç¡®ä¿ï¼š</p>
        <ul>
            <li>å·²è¿æ¥è‡³å°‘ä¸€å°Androidè®¾å¤‡</li>
            <li>å‡†å¤‡äº†æµ‹è¯•ç”¨çš„è”ç³»äººæ–‡ä»¶</li>
            <li>è®¾å¤‡å·²å¼€å¯USBè°ƒè¯•</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤1: è®¾å¤‡é€‰æ‹©</h3>
        <input type="text" id="deviceId" placeholder="è¾“å…¥è®¾å¤‡ID (å¦‚: emulator-5554)" style="width: 200px; padding: 5px;">
        <button onclick="detectDevices()">è‡ªåŠ¨æ£€æµ‹è®¾å¤‡</button>
        <div id="deviceList"></div>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤2: é€‰æ‹©è”ç³»äººæ–‡ä»¶</h3>
        <input type="file" id="fileInput" accept=".txt,.csv,.vcf" onchange="handleFileSelect()">
        <p id="fileInfo"></p>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤3: æµ‹è¯•å¯¼å…¥</h3>
        <button onclick="testVcfImport()" id="testBtn" disabled>å¼€å§‹æµ‹è¯•å¯¼å…¥</button>
        <button onclick="testCrashFix()" id="crashTestBtn" disabled>æµ‹è¯•å´©æºƒä¿®å¤</button>
        <div id="testResult"></div>
    </div>

    <div class="test-section">
        <h3>æ—¥å¿—è¾“å‡º</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        import { invoke } from '/tauri.js';
        
        let selectedDeviceId = '';
        let selectedFilePath = '';
        
        window.log = function(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}">${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        window.detectDevices = async function() {
            log('å¼€å§‹æ£€æµ‹è®¾å¤‡...');
            try {
                const devices = await invoke('get_adb_devices');
                const deviceList = document.getElementById('deviceList');
                if (devices && devices.length > 0) {
                    deviceList.innerHTML = '<h4>æ£€æµ‹åˆ°çš„è®¾å¤‡:</h4>';
                    devices.forEach(device => {
                        const button = document.createElement('button');
                        button.textContent = device;
                        button.onclick = () => selectDevice(device);
                        deviceList.appendChild(button);
                    });
                    log(`æ£€æµ‹åˆ° ${devices.length} å°è®¾å¤‡`, 'success');
                } else {
                    deviceList.innerHTML = '<p style="color: orange;">æœªæ£€æµ‹åˆ°è®¾å¤‡ï¼Œè¯·æ£€æŸ¥USBè¿æ¥å’Œè°ƒè¯•è®¾ç½®</p>';
                    log('æœªæ£€æµ‹åˆ°è®¾å¤‡', 'error');
                }
            } catch (error) {
                log(`è®¾å¤‡æ£€æµ‹å¤±è´¥: ${error}`, 'error');
                document.getElementById('deviceList').innerHTML = '<p style="color: red;">è®¾å¤‡æ£€æµ‹å¤±è´¥</p>';
            }
        };
        
        window.selectDevice = function(deviceId) {
            selectedDeviceId = deviceId;
            document.getElementById('deviceId').value = deviceId;
            log(`å·²é€‰æ‹©è®¾å¤‡: ${deviceId}`, 'success');
            updateTestButtons();
        };
        
        window.handleFileSelect = function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                selectedFilePath = file.path || file.name;
                document.getElementById('fileInfo').innerHTML = `
                    <p><strong>æ–‡ä»¶å:</strong> ${file.name}</p>
                    <p><strong>å¤§å°:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    <p><strong>ç±»å‹:</strong> ${file.type || 'æœªçŸ¥'}</p>
                `;
                log(`å·²é€‰æ‹©æ–‡ä»¶: ${file.name}`, 'success');
                updateTestButtons();
            }
        };
        
        function updateTestButtons() {
            const hasDevice = selectedDeviceId !== '';
            const hasFile = selectedFilePath !== '';
            document.getElementById('testBtn').disabled = !(hasDevice && hasFile);
            document.getElementById('crashTestBtn').disabled = !(hasDevice && hasFile);
        }
        
        window.testVcfImport = async function() {
            if (!selectedDeviceId || !selectedFilePath) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡å’Œæ–‡ä»¶');
                return;
            }
            
            log('å¼€å§‹æµ‹è¯•VCFå¯¼å…¥...');
            document.getElementById('testBtn').disabled = true;
            
            try {
                const result = await invoke('import_vcf_contacts_async_safe', {
                    deviceId: selectedDeviceId,
                    contactsFilePath: selectedFilePath
                });
                
                const resultDiv = document.getElementById('testResult');
                if (result.success) {
                    resultDiv.className = 'test-section success';
                    resultDiv.innerHTML = `
                        <h4>âœ… å¯¼å…¥æˆåŠŸï¼</h4>
                        <p><strong>æ€»è”ç³»äºº:</strong> ${result.total_contacts}</p>
                        <p><strong>å·²å¯¼å…¥:</strong> ${result.imported_contacts}</p>
                        <p><strong>å¤±è´¥:</strong> ${result.failed_contacts}</p>
                        <p><strong>è€—æ—¶:</strong> ${result.duration || 0} ç§’</p>
                        <p><strong>æ¶ˆæ¯:</strong> ${result.message}</p>
                        ${result.details ? `<p><strong>è¯¦æƒ…:</strong> ${result.details}</p>` : ''}
                    `;
                    log('VCFå¯¼å…¥æˆåŠŸå®Œæˆ', 'success');
                } else {
                    resultDiv.className = 'test-section error';
                    resultDiv.innerHTML = `
                        <h4>âŒ å¯¼å…¥å¤±è´¥</h4>
                        <p><strong>é”™è¯¯æ¶ˆæ¯:</strong> ${result.message}</p>
                        ${result.details ? `<p><strong>é”™è¯¯è¯¦æƒ…:</strong> ${result.details}</p>` : ''}
                    `;
                    log(`VCFå¯¼å…¥å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                document.getElementById('testResult').className = 'test-section error';
                document.getElementById('testResult').innerHTML = `
                    <h4>ğŸ’¥ ç¨‹åºé”™è¯¯</h4>
                    <p><strong>é”™è¯¯:</strong> ${error}</p>
                `;
                log(`ç¨‹åºé”™è¯¯: ${error}`, 'error');
            } finally {
                document.getElementById('testBtn').disabled = false;
            }
        };
        
        window.testCrashFix = async function() {
            if (!selectedDeviceId || !selectedFilePath) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡å’Œæ–‡ä»¶');
                return;
            }
            
            log('å¼€å§‹æµ‹è¯•å´©æºƒä¿®å¤...');
            document.getElementById('crashTestBtn').disabled = true;
            
            try {
                const result = await invoke('test_vcf_import_crash_fix', {
                    deviceId: selectedDeviceId,
                    contactsFilePath: selectedFilePath
                });
                
                const resultDiv = document.getElementById('testResult');
                resultDiv.className = 'test-section success';
                resultDiv.innerHTML = `
                    <h4>ğŸ›¡ï¸ å´©æºƒä¿®å¤æµ‹è¯•</h4>
                    <p><strong>ç»“æœ:</strong> ${result}</p>
                    <p>å¦‚æœç¨‹åºæ²¡æœ‰å´©æºƒï¼Œè¯´æ˜ä¿®å¤æœ‰æ•ˆï¼</p>
                `;
                log(`å´©æºƒä¿®å¤æµ‹è¯•å®Œæˆ: ${result}`, 'success');
            } catch (error) {
                document.getElementById('testResult').className = 'test-section error';
                document.getElementById('testResult').innerHTML = `
                    <h4>âš ï¸ å´©æºƒä¿®å¤æµ‹è¯•</h4>
                    <p><strong>æ•è·åˆ°é”™è¯¯:</strong> ${error}</p>
                    <p>ç¨‹åºæ²¡æœ‰å´©æºƒï¼Œé”™è¯¯è¢«å®‰å…¨å¤„ç†ï¼</p>
                `;
                log(`å´©æºƒä¿®å¤æµ‹è¯•æ•è·é”™è¯¯: ${error}`, 'error');
            } finally {
                document.getElementById('crashTestBtn').disabled = false;
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹è®¾å¤‡
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
            detectDevices();
        });
    </script>
</body>
</html>