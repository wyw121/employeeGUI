<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è„šæœ¬ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #40a9ff;
        }
        
        .test-button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        .log-container {
            background: #001529;
            color: #fff;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        
        .test-section {
            margin-bottom: 30px;
        }
        
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #262626;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        
        .status.success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .status.error {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
        
        .status.running {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ™ºèƒ½è„šæœ¬ç³»ç»Ÿæµ‹è¯•å·¥å…·</h1>
    
    <div class="test-container">
        <div class="test-section">
            <div class="test-title">ğŸ“‹ è„šæœ¬ç®¡ç†åŠŸèƒ½æµ‹è¯•</div>
            <button class="test-button" onclick="testScriptManagement()">æµ‹è¯•è„šæœ¬ç®¡ç†</button>
            <button class="test-button" onclick="testScriptTemplates()">æµ‹è¯•è„šæœ¬æ¨¡æ¿</button>
            <button class="test-button" onclick="testScriptCRUD()">æµ‹è¯•CRUDæ“ä½œ</button>
            <span id="script-management-status" class="status"></span>
        </div>
        
        <div class="test-section">
            <div class="test-title">âš¡ è„šæœ¬æ‰§è¡ŒåŠŸèƒ½æµ‹è¯•</div>
            <button class="test-button" onclick="testScriptExecution()">æµ‹è¯•è„šæœ¬æ‰§è¡Œ</button>
            <button class="test-button" onclick="testDeviceConnection()">æµ‹è¯•è®¾å¤‡è¿æ¥</button>
            <button class="test-button" onclick="testBatchExecution()">æµ‹è¯•æ‰¹é‡æ‰§è¡Œ</button>
            <span id="script-execution-status" class="status"></span>
        </div>
        
        <div class="test-section">
            <div class="test-title">ğŸ¯ ç»¼åˆæµ‹è¯•</div>
            <button class="test-button" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="test-button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>
    
    <div class="test-container">
        <div class="test-title">ğŸ“Š æµ‹è¯•æ—¥å¿—</div>
        <div id="log-container" class="log-container"></div>
    </div>

    <script>
        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warn' ? 'âš ï¸' : 'â„¹ï¸';
            const logMessage = `[${timestamp}] ${prefix} ${message}`;
            
            const logContainer = document.getElementById('log-container');
            logContainer.textContent += logMessage + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(logMessage);
        }

        function clearLogs() {
            document.getElementById('log-container').textContent = '';
        }

        function setStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = text;
        }

        // æ£€æŸ¥ Tauri API æ˜¯å¦å¯ç”¨
        function checkTauriAPI() {
            if (typeof window.__TAURI__ === 'undefined') {
                log('Tauri API ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿åœ¨ Tauri åº”ç”¨ä¸­è¿è¡Œ', 'error');
                return false;
            }
            return true;
        }

        // æµ‹è¯•è„šæœ¬ç®¡ç†åŠŸèƒ½
        async function testScriptManagement() {
            if (!checkTauriAPI()) return;
            
            log('ğŸ§ª å¼€å§‹æµ‹è¯•è„šæœ¬ç®¡ç†åŠŸèƒ½...');
            setStatus('script-management-status', 'running', 'æµ‹è¯•ä¸­...');

            try {
                const { invoke } = window.__TAURI__.tauri;

                // 1. æµ‹è¯•åˆ›å»ºè„šæœ¬
                log('ğŸ“ æµ‹è¯•åˆ›å»ºæ™ºèƒ½è„šæœ¬...');
                const testScript = {
                    name: 'æµ‹è¯•è„šæœ¬_' + Date.now(),
                    description: 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬',
                    steps: [
                        {
                            type: 'click',
                            target: 'ç™»å½•æŒ‰é’®',
                            description: 'ç‚¹å‡»ç™»å½•æŒ‰é’®',
                            config: {
                                element_selector: 'text("ç™»å½•")',
                                wait_after: 1000
                            }
                        }
                    ],
                    config: {
                        continue_on_error: false,
                        auto_verification_enabled: true,
                        smart_recovery_enabled: true,
                        detailed_logging: true
                    },
                    tags: ['æµ‹è¯•', 'ç™»å½•'],
                    created_by: 'Test User'
                };

                const scriptId = await invoke('save_smart_script', {
                    script: testScript
                });
                log(`è„šæœ¬åˆ›å»ºæˆåŠŸï¼ŒID: ${scriptId}`, 'success');

                // 2. æµ‹è¯•è¯»å–è„šæœ¬
                log('ğŸ“– æµ‹è¯•è¯»å–è„šæœ¬...');
                const savedScript = await invoke('load_smart_script', {
                    scriptId: scriptId
                });
                log(`è„šæœ¬è¯»å–æˆåŠŸ: ${savedScript.name}`, 'success');

                // 3. æµ‹è¯•åˆ—å‡ºæ‰€æœ‰è„šæœ¬
                log('ğŸ“œ æµ‹è¯•åˆ—å‡ºæ‰€æœ‰è„šæœ¬...');
                const allScripts = await invoke('list_smart_scripts');
                log(`æ‰¾åˆ° ${allScripts.length} ä¸ªè„šæœ¬`, 'success');

                // 4. æµ‹è¯•åˆ é™¤è„šæœ¬
                log('ğŸ—‘ï¸ æµ‹è¯•åˆ é™¤è„šæœ¬...');
                await invoke('delete_smart_script', {
                    scriptId: scriptId
                });
                log('è„šæœ¬åˆ é™¤æˆåŠŸ', 'success');

                setStatus('script-management-status', 'success', 'æµ‹è¯•é€šè¿‡');
                log('ğŸ‰ è„šæœ¬ç®¡ç†åŠŸèƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');

            } catch (error) {
                log(`è„šæœ¬ç®¡ç†æµ‹è¯•å¤±è´¥: ${error}`, 'error');
                setStatus('script-management-status', 'error', 'æµ‹è¯•å¤±è´¥');
            }
        }

        // æµ‹è¯•è„šæœ¬æ¨¡æ¿
        async function testScriptTemplates() {
            if (!checkTauriAPI()) return;
            
            log('ğŸ“‹ å¼€å§‹æµ‹è¯•è„šæœ¬æ¨¡æ¿...');

            try {
                const { invoke } = window.__TAURI__.tauri;

                const templates = await invoke('list_script_templates');
                log(`è·å–åˆ° ${templates.length} ä¸ªè„šæœ¬æ¨¡æ¿`, 'success');

                for (const template of templates) {
                    log(`æ¨¡æ¿: ${template.name} - ${template.description}`);
                }

                if (templates.length > 0) {
                    // æµ‹è¯•ä»æ¨¡æ¿åˆ›å»ºè„šæœ¬
                    const templateName = templates[0].name;
                    log(`å°è¯•ä»æ¨¡æ¿ "${templateName}" åˆ›å»ºè„šæœ¬...`);
                    
                    const scriptFromTemplate = await invoke('create_script_from_template', {
                        templateName: templateName,
                        scriptName: 'ä»æ¨¡æ¿åˆ›å»ºçš„è„šæœ¬_' + Date.now()
                    });
                    log(`ä»æ¨¡æ¿åˆ›å»ºè„šæœ¬æˆåŠŸ: ${scriptFromTemplate.name}`, 'success');
                }

            } catch (error) {
                log(`è„šæœ¬æ¨¡æ¿æµ‹è¯•å¤±è´¥: ${error}`, 'error');
            }
        }

        // æµ‹è¯• CRUD æ“ä½œ
        async function testScriptCRUD() {
            if (!checkTauriAPI()) return;
            
            log('ğŸ”„ å¼€å§‹æµ‹è¯•è„šæœ¬ CRUD æ“ä½œ...');

            try {
                const { invoke } = window.__TAURI__.tauri;

                // Create
                const script = {
                    name: 'CRUDæµ‹è¯•è„šæœ¬_' + Date.now(),
                    description: 'æµ‹è¯•CRUDæ“ä½œçš„è„šæœ¬',
                    steps: [],
                    config: {
                        continue_on_error: true,
                        auto_verification_enabled: false,
                        smart_recovery_enabled: false,
                        detailed_logging: true
                    },
                    tags: ['CRUD', 'æµ‹è¯•'],
                    created_by: 'CRUD Tester'
                };

                const id = await invoke('save_smart_script', { script });
                log(`åˆ›å»ºæˆåŠŸ: ID=${id}`, 'success');

                // Read
                const readScript = await invoke('load_smart_script', { scriptId: id });
                log(`è¯»å–æˆåŠŸ: ${readScript.name}`, 'success');

                // Update (é€šè¿‡å†æ¬¡ä¿å­˜ç›¸åŒID)
                readScript.description = 'æ›´æ–°åçš„æè¿°_' + Date.now();
                await invoke('save_smart_script', { script: readScript });
                log('æ›´æ–°æˆåŠŸ', 'success');

                // Delete
                await invoke('delete_smart_script', { scriptId: id });
                log('åˆ é™¤æˆåŠŸ', 'success');

                log('ğŸ‰ CRUD æ“ä½œæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');

            } catch (error) {
                log(`CRUD æµ‹è¯•å¤±è´¥: ${error}`, 'error');
            }
        }

        // æµ‹è¯•è„šæœ¬æ‰§è¡Œ
        async function testScriptExecution() {
            if (!checkTauriAPI()) return;
            
            log('âš¡ å¼€å§‹æµ‹è¯•è„šæœ¬æ‰§è¡Œ...');
            setStatus('script-execution-status', 'running', 'æµ‹è¯•ä¸­...');

            try {
                const { invoke } = window.__TAURI__.tauri;

                // è·å–è®¾å¤‡åˆ—è¡¨
                log('ğŸ“± è·å–è®¾å¤‡åˆ—è¡¨...');
                let devices;
                try {
                    devices = await invoke('get_connected_devices');
                    log(`æ‰¾åˆ° ${devices.length} ä¸ªè¿æ¥çš„è®¾å¤‡`, 'success');
                } catch (deviceError) {
                    log(`è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥: ${deviceError}`, 'warn');
                    devices = ['emulator-5554']; // ä½¿ç”¨é»˜è®¤è®¾å¤‡
                    log('ä½¿ç”¨é»˜è®¤è®¾å¤‡è¿›è¡Œæµ‹è¯•', 'warn');
                }

                const deviceId = devices[0] || 'emulator-5554';
                log(`ä½¿ç”¨è®¾å¤‡: ${deviceId}`);

                // æµ‹è¯•è„šæœ¬æ‰§è¡Œ
                log('ğŸš€ æµ‹è¯•è„šæœ¬æ‰§è¡Œ...');
                
                const testSteps = [
                    {
                        type: 'click',
                        target: 'æµ‹è¯•æŒ‰é’®',
                        description: 'ç‚¹å‡»æµ‹è¯•æŒ‰é’®',
                        config: {
                            element_selector: 'text("æµ‹è¯•æŒ‰é’®")',
                            wait_after: 1000
                        }
                    }
                ];

                const result = await invoke('execute_smart_automation_script', {
                    deviceId: deviceId,
                    steps: testSteps,
                    config: {
                        continue_on_error: true,
                        auto_verification_enabled: false,
                        smart_recovery_enabled: false,
                        detailed_logging: true
                    }
                });

                log(`è„šæœ¬æ‰§è¡Œå®Œæˆ: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, result.success ? 'success' : 'error');
                if (result.message) {
                    log(`æ‰§è¡Œæ¶ˆæ¯: ${result.message}`);
                }

                setStatus('script-execution-status', result.success ? 'success' : 'error', result.success ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥');

            } catch (error) {
                log(`è„šæœ¬æ‰§è¡Œæµ‹è¯•å¤±è´¥: ${error}`, 'error');
                setStatus('script-execution-status', 'error', 'æµ‹è¯•å¤±è´¥');
            }
        }

        // æµ‹è¯•è®¾å¤‡è¿æ¥
        async function testDeviceConnection() {
            if (!checkTauriAPI()) return;
            
            log('ğŸ“± å¼€å§‹æµ‹è¯•è®¾å¤‡è¿æ¥...');

            try {
                const { invoke } = window.__TAURI__.tauri;

                const devices = await invoke('get_connected_devices');
                log(`è¿æ¥çš„è®¾å¤‡æ•°é‡: ${devices.length}`, 'success');

                for (const device of devices) {
                    log(`è®¾å¤‡: ${device}`);
                }

                if (devices.length === 0) {
                    log('æ²¡æœ‰æ‰¾åˆ°è¿æ¥çš„è®¾å¤‡', 'warn');
                } else {
                    log('è®¾å¤‡è¿æ¥æµ‹è¯•é€šè¿‡', 'success');
                }

            } catch (error) {
                log(`è®¾å¤‡è¿æ¥æµ‹è¯•å¤±è´¥: ${error}`, 'error');
            }
        }

        // æµ‹è¯•æ‰¹é‡æ‰§è¡Œ
        async function testBatchExecution() {
            if (!checkTauriAPI()) return;
            
            log('ğŸ”„ å¼€å§‹æµ‹è¯•æ‰¹é‡æ‰§è¡Œ...');

            try {
                const { invoke } = window.__TAURI__.tauri;

                // åˆ›å»ºå¤šä¸ªæµ‹è¯•æ­¥éª¤
                const batchSteps = [
                    {
                        type: 'click',
                        target: 'æŒ‰é’®1',
                        description: 'ç‚¹å‡»ç¬¬ä¸€ä¸ªæŒ‰é’®',
                        config: { element_selector: 'text("æŒ‰é’®1")', wait_after: 500 }
                    },
                    {
                        type: 'click',
                        target: 'æŒ‰é’®2',
                        description: 'ç‚¹å‡»ç¬¬äºŒä¸ªæŒ‰é’®',
                        config: { element_selector: 'text("æŒ‰é’®2")', wait_after: 500 }
                    },
                    {
                        type: 'click',
                        target: 'æŒ‰é’®3',
                        description: 'ç‚¹å‡»ç¬¬ä¸‰ä¸ªæŒ‰é’®',
                        config: { element_selector: 'text("æŒ‰é’®3")', wait_after: 500 }
                    }
                ];

                const deviceId = 'emulator-5554';
                log(`æ‰¹é‡æ‰§è¡Œ ${batchSteps.length} ä¸ªæ­¥éª¤...`);

                const result = await invoke('execute_smart_automation_script', {
                    deviceId: deviceId,
                    steps: batchSteps,
                    config: {
                        continue_on_error: true,
                        auto_verification_enabled: false,
                        smart_recovery_enabled: false,
                        detailed_logging: true
                    }
                });

                log(`æ‰¹é‡æ‰§è¡Œå®Œæˆ: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, result.success ? 'success' : 'error');
                log(`æ‰§è¡Œæ¶ˆæ¯: ${result.message}`);

            } catch (error) {
                log(`æ‰¹é‡æ‰§è¡Œæµ‹è¯•å¤±è´¥: ${error}`, 'error');
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            log('ğŸ¯ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            log('='.repeat(50));

            await testScriptManagement();
            log('');
            await testScriptTemplates();
            log('');
            await testScriptCRUD();
            log('');
            await testScriptExecution();
            log('');
            await testDeviceConnection();
            log('');
            await testBatchExecution();

            log('='.repeat(50));
            log('ğŸ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ æ™ºèƒ½è„šæœ¬ç³»ç»Ÿæµ‹è¯•å·¥å…·å·²åŠ è½½');
            log('ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•å„é¡¹åŠŸèƒ½');
        });
    </script>
</body>
</html>