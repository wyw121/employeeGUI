# ç‰ˆæœ¬å·®å¼‚åˆ†ææŠ¥å‘Šï¼šé€šè®¯å½•å¯¼å…¥åŠŸèƒ½é—®é¢˜

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

æ—§ç‰ˆæœ¬ï¼ˆfb9786ff54fd41eb5584fbedf342de30842e6b5eï¼‰çš„é€šè®¯å½•å¯¼å…¥åŠŸèƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†å½“å‰æœ€æ–°ç‰ˆæœ¬æ— æ³•æ­£å¸¸å¯¼å…¥ã€‚

## ğŸ” æ ¸å¿ƒå·®å¼‚åˆ†æ

### 1. **å‰ç«¯è°ƒç”¨æ–¹å¼å®Œå…¨ä¸åŒ**

**æ—§ç‰ˆæœ¬å‰ç«¯ï¼ˆå¯ä»¥å·¥ä½œï¼‰ï¼š**
```typescript
// æ–¹æ³•1ï¼šä½¿ç”¨generate_vcf_file + import_vcf_contacts_async_safe
const vcfFilePath = await invoke<string>("generate_vcf_file", {
  contacts: group.contacts.map(contact => ({
    id: contact.id?.toString() || '',
    name: contact.name,
    phone: contact.phone || '',
    email: contact.email || '',
    address: contact.notes || '',
    occupation: ''
  })),
  fileName: `contacts_${Date.now()}_${group.deviceId.replace(/[^a-zA-Z0-9]/g, '_')}.vcf`
});

const importResult = await invoke<VcfImportResult>("import_vcf_contacts_async_safe", {
  deviceId: group.deviceId,
  vcfFilePath: vcfFilePath
});
```

```typescript
// æ–¹æ³•2ï¼ˆå¤‡é€‰ï¼‰ï¼šä½¿ç”¨test_vcf_import_with_permission
const permissionTestResult = await invoke<string>("test_vcf_import_with_permission", {
  deviceId: group.deviceId,
  contactsFile: tempPath,
});
```

**æ–°ç‰ˆæœ¬å‰ç«¯ï¼ˆæ— æ³•å·¥ä½œï¼‰ï¼š**
```typescript
// ç›´æ¥è°ƒç”¨import_vcf_to_deviceå‘½ä»¤
const result = await invoke<string>('import_vcf_to_device', {
  deviceId: group.deviceId,
  vcfContent: vcfContent,
  contactCount: group.contacts.length
});
```

### 2. **åç«¯å‘½ä»¤æ³¨å†Œæƒ…å†µ**

**æ—§ç‰ˆæœ¬åç«¯å‘½ä»¤ï¼š**
- âœ… `generate_vcf_file` - ç”ŸæˆVCFæ–‡ä»¶
- âœ… `import_vcf_contacts_async_safe` - å¼‚æ­¥å®‰å…¨å¯¼å…¥
- âœ… `test_vcf_import_with_permission` - æƒé™æµ‹è¯•å¯¼å…¥
- âŒ `import_vcf_to_device` - **ä¸å­˜åœ¨**

**æ–°ç‰ˆæœ¬åç«¯å‘½ä»¤ï¼š**
- âœ… `generate_vcf_file` - ä¾ç„¶å­˜åœ¨
- âœ… `import_vcf_contacts_async_safe` - ä¾ç„¶å­˜åœ¨
- âœ… `test_vcf_import_with_permission` - ä¾ç„¶å­˜åœ¨
- âœ… `import_vcf_to_device` - **æ–°å¢å‘½ä»¤**

### 3. **é—®é¢˜æ ¹æº**

æ–°ç‰ˆæœ¬çš„å‰ç«¯ä»£ç è¢«é‡æ„ä¸ºä½¿ç”¨ç»Ÿä¸€çš„ `import_vcf_to_device` å‘½ä»¤ï¼Œä½†æ˜¯ï¼š

1. **æ¶æ„ä¸åŒ¹é…**ï¼šæ–°ç‰ˆæœ¬åç«¯ç¡®å®æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œä½†å‰ç«¯è°ƒç”¨æ–¹å¼å¯èƒ½ä¸åç«¯å®ç°ä¸åŒ¹é…
2. **æ•°æ®æ ¼å¼å·®å¼‚**ï¼šæ–°ç‰ˆæœ¬ä¼ é€’çš„æ˜¯ `vcfContent` å­—ç¬¦ä¸²ï¼Œè€Œæ—§ç‰ˆæœ¬æ˜¯å…ˆç”Ÿæˆæ–‡ä»¶å†ä¼ é€’æ–‡ä»¶è·¯å¾„
3. **é”™è¯¯å¤„ç†æœºåˆ¶**ï¼šæ–°ç‰ˆæœ¬çš„é”™è¯¯å¤„ç†å’Œç»“æœè§£æé€»è¾‘ä¸æ—§ç‰ˆæœ¬ä¸åŒ

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå›é€€åˆ°æ—§ç‰ˆæœ¬çš„å·¥ä½œæ–¹å¼ï¼ˆæ¨èï¼‰

ä¿®æ”¹æ–°ç‰ˆæœ¬çš„å‰ç«¯ä»£ç ï¼Œä½¿å…¶ä½¿ç”¨æ—§ç‰ˆæœ¬å·²éªŒè¯å·¥ä½œçš„è°ƒç”¨æ–¹å¼ï¼š

```typescript
// æ¢å¤æ—§ç‰ˆæœ¬çš„åŒé‡å¤‡é€‰æœºåˆ¶
try {
  // æ–¹æ³•1ï¼šä½¿ç”¨VCFæ–‡ä»¶æ–¹å¼
  const vcfFilePath = await invoke<string>("generate_vcf_file", {
    contacts: group.contacts.map(contact => ({
      id: contact.id?.toString() || '',
      name: contact.name,
      phone: contact.phone || '',
      email: contact.email || '',
      address: contact.notes || '',
      occupation: ''
    })),
    fileName: `contacts_${Date.now()}_${group.deviceId}.vcf`
  });

  const importResult = await invoke<VcfImportResult>("import_vcf_contacts_async_safe", {
    deviceId: group.deviceId,
    vcfFilePath: vcfFilePath
  });

  return importResult;
} catch (error) {
  // æ–¹æ³•2ï¼šå¤‡é€‰æƒé™æµ‹è¯•æ–¹å¼
  const permissionTestResult = await invoke<string>("test_vcf_import_with_permission", {
    deviceId: group.deviceId,
    contactsFile: tempPath,
  });
  
  // è§£æç»“æœ...
}
```

### æ–¹æ¡ˆ2ï¼šä¿®å¤æ–°ç‰ˆæœ¬çš„import_vcf_to_deviceå‘½ä»¤

æ£€æŸ¥å¹¶ä¿®å¤ `import_vcf_to_device` å‘½ä»¤çš„å®ç°ï¼Œç¡®ä¿å…¶èƒ½æ­£ç¡®å¤„ç†å‰ç«¯ä¼ é€’çš„æ•°æ®ã€‚

## ğŸ“Š å½±å“èŒƒå›´

- **å‰ç«¯ç»„ä»¶**ï¼š`src/components/contact/ContactImportManager.tsx`
- **åç«¯å‘½ä»¤**ï¼š`src-tauri/src/services/contact_automation.rs`
- **å‘½ä»¤æ³¨å†Œ**ï¼š`src-tauri/src/main.rs`

## ğŸ¯ æ¨èè¡ŒåŠ¨

1. **ç«‹å³å›é€€**ï¼šå°†å‰ç«¯ä»£ç æ”¹å›ä½¿ç”¨æ—§ç‰ˆæœ¬çš„è°ƒç”¨æ–¹å¼
2. **ä¿æŒå…¼å®¹**ï¼šåŒæ—¶ä¿ç•™æ–°æ—§ä¸¤å¥—åç«¯å‘½ä»¤ï¼Œç¡®ä¿å‘åå…¼å®¹
3. **å……åˆ†æµ‹è¯•**ï¼šåœ¨çœŸå®è®¾å¤‡ä¸ŠéªŒè¯ä¿®å¤æ•ˆæœ

## ğŸ“ æ€»ç»“

é—®é¢˜çš„æ ¸å¿ƒæ˜¯å‰ç«¯è°ƒç”¨æ–¹å¼å‘ç”Ÿäº†æ ¹æœ¬æ€§å˜åŒ–ï¼Œä»ä½¿ç”¨å·²éªŒè¯å·¥ä½œçš„ `import_vcf_contacts_async_safe` å‘½ä»¤æ”¹ä¸ºä½¿ç”¨æ–°çš„ `import_vcf_to_device` å‘½ä»¤ï¼Œä½†æ–°å‘½ä»¤çš„å®ç°æˆ–è°ƒç”¨æ–¹å¼å­˜åœ¨é—®é¢˜ã€‚

æœ€ç¨³å¦¥çš„è§£å†³æ–¹æ¡ˆæ˜¯å›é€€åˆ°æ—§ç‰ˆæœ¬å·²éªŒè¯å·¥ä½œçš„è°ƒç”¨æ–¹å¼ã€‚